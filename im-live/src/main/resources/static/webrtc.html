<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
    <title>WebRTC æ¨æ‹‰æµæµ‹è¯• (SRS å…¼å®¹)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            color: #4CAF50;
        }

        .section {
            background: #2a2a2a;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .section h2 {
            margin-bottom: 15px;
            color: #4CAF50;
        }

        .input-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            color: #ccc;
        }

        input {
            width: 100%;
            padding: 10px;
            background: #1a1a1a;
            border: 1px solid #444;
            border-radius: 4px;
            color: #fff;
            font-size: 14px;
        }

        button {
            padding: 10px 20px;
            background: #4CAF50;
            color: #fff;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        button:hover {
            background: #45a049;
        }

        button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        button.stop {
            background: #f44336;
        }

        button.stop:hover {
            background: #da190b;
        }

        video {
            width: 100%;
            max-width: 640px;
            background: #000;
            border-radius: 4px;
            margin-top: 15px;
        }

        .status {
            margin-top: 15px;
            padding: 10px;
            background: #333;
            border-radius: 4px;
            font-size: 12px;
            color: #ccc;
        }

        .status.success {
            color: #4CAF50;
        }

        .status.error {
            color: #f44336;
        }

        .info {
            background: #1a1a1a;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
            font-size: 12px;
            color: #999;
        }
    </style>
</head>
<body>
<div class="container">
    <h1>WebRTC æ¨æ‹‰æµæµ‹è¯• (SRS å…¼å®¹æ¥å£)</h1>

    <!-- æ¨æµåŒºåŸŸ -->
    <div class="section">
        <h2>ğŸ“¹ æ¨æµ</h2>
        <div class="input-group">
            <label>æµ URL (æ ¼å¼: webrtc://localhost/app/stream)</label>
            <input id="publishUrl" placeholder="webrtc://localhost/live/stream1" type="text"
                   value="webrtc://localhost/live/stream1">
        </div>
        <div class="input-group">
            <label>API åœ°å€</label>
            <input id="apiUrl" placeholder="http://localhost:1985" type="text" value="http://localhost:1985">
        </div>
        <button id="startPublish">å¼€å§‹æ¨æµ</button>
        <button class="stop" disabled id="stopPublish">åœæ­¢æ¨æµ</button>
        <video autoplay id="localVideo" muted playsinline></video>
        <div class="status" id="publishStatus"></div>
    </div>

    <!-- æ‹‰æµåŒºåŸŸ -->
    <div class="section">
        <h2>ğŸ“º æ‹‰æµ</h2>
        <div class="input-group">
            <label>æµ URL (æ ¼å¼: webrtc://localhost/app/stream)</label>
            <input id="playUrl" placeholder="webrtc://localhost/live/stream1" type="text"
                   value="webrtc://localhost/live/stream1">
        </div>
        <div class="input-group">
            <label>API åœ°å€</label>
            <input id="playApiUrl" placeholder="http://localhost:1985" type="text" value="http://localhost:1985">
        </div>
        <button id="startPlay">å¼€å§‹æ‹‰æµ</button>
        <button class="stop" disabled id="stopPlay">åœæ­¢æ‹‰æµ</button>
        <video autoplay id="remoteVideo" playsinline></video>
        <div class="status" id="playStatus"></div>
    </div>

    <!-- ä½¿ç”¨è¯´æ˜ -->
    <div class="section">
        <h2>ğŸ“– ä½¿ç”¨è¯´æ˜</h2>
        <div class="info">
            <p><strong>æµ URL æ ¼å¼ï¼š</strong> webrtc://domain/app/stream</p>
            <p>- domain: æœåŠ¡å™¨åœ°å€ï¼ˆå¦‚ localhostï¼‰</p>
            <p>- app: åº”ç”¨åç§°ï¼ˆæ˜ å°„ä¸º roomIdï¼Œå¦‚ liveï¼‰</p>
            <p>- stream: æµåç§°ï¼ˆæ˜ å°„ä¸º streamIdï¼Œå¦‚ stream1ï¼‰</p>
            <br>
            <p><strong>æ¨æµæ­¥éª¤ï¼š</strong></p>
            <p>1. è¾“å…¥æµ URL å’Œ API åœ°å€</p>
            <p>2. ç‚¹å‡»"å¼€å§‹æ¨æµ"æŒ‰é’®</p>
            <p>3. å…è®¸æµè§ˆå™¨è®¿é—®æ‘„åƒå¤´å’Œéº¦å…‹é£</p>
            <p>4. ç­‰å¾…è¿æ¥å»ºç«‹ï¼Œè§†é¢‘æ˜¾ç¤ºåœ¨æœ¬åœ°è§†é¢‘çª—å£</p>
            <br>
            <p><strong>æ‹‰æµæ­¥éª¤ï¼š</strong></p>
            <p>1. è¾“å…¥è¦æ‹‰å–çš„æµ URLï¼ˆå¿…é¡»ä¸æ¨æµçš„ URL ä¸€è‡´ï¼‰</p>
            <p>2. ç‚¹å‡»"å¼€å§‹æ‹‰æµ"æŒ‰é’®</p>
            <p>3. ç­‰å¾…è¿æ¥å»ºç«‹ï¼Œè§†é¢‘æ˜¾ç¤ºåœ¨è¿œç¨‹è§†é¢‘çª—å£</p>
        </div>
    </div>
</div>

<script>
    // é…ç½®
    const config = {
        iceServers: [
            {urls: 'stun:stun.l.google.com:19302'}
        ]
    };

    let publishPc = null;
    let playPc = null;
    let localStream = null;

    // ==================== æ¨æµåŠŸèƒ½ ====================

    document.getElementById('startPublish').addEventListener('click', async () => {
        const apiUrl = document.getElementById('apiUrl').value.trim();
        const streamUrl = document.getElementById('publishUrl').value.trim();
        const statusEl = document.getElementById('publishStatus');

        if (!apiUrl || !streamUrl) {
            statusEl.textContent = 'é”™è¯¯: è¯·å¡«å†™ API åœ°å€å’Œæµ URL';
            statusEl.className = 'status error';
            return;
        }

        try {
            statusEl.textContent = 'æ­£åœ¨è·å–æœ¬åœ°åª’ä½“...';
            statusEl.className = 'status';

            // è·å–æœ¬åœ°åª’ä½“æµ
            localStream = await navigator.mediaDevices.getUserMedia({
                video: true,
                audio: true
            });

            document.getElementById('localVideo').srcObject = localStream;

            // åˆ›å»º PeerConnection
            publishPc = new RTCPeerConnection(config);

            // æ·»åŠ åª’ä½“è½¨é“
            localStream.getTracks().forEach(track => {
                publishPc.addTrack(track, localStream);
            });

            // åˆ›å»º Offer
            statusEl.textContent = 'æ­£åœ¨åˆ›å»º SDP Offer...';
            const offer = await publishPc.createOffer();
            await publishPc.setLocalDescription(offer);

            // å‘é€åˆ°æœåŠ¡å™¨
            statusEl.textContent = 'æ­£åœ¨è¿æ¥æœåŠ¡å™¨...';
            const response = await fetch(`${apiUrl}/rtc/v1/publish/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    api: streamUrl,
                    sdp: offer.sdp
                })
            });

            const data = await response.json();

            if (data.code !== 0) {
                throw new Error(data.data?.error || 'æœåŠ¡å™¨è¿”å›é”™è¯¯');
            }

            // è®¾ç½® Answer
            await publishPc.setRemoteDescription({
                type: 'answer',
                sdp: data.sdp
            });

            // å¤„ç† ICE å€™é€‰
            publishPc.onicecandidate = (event) => {
                if (event.candidate) {
                    // å¯ä»¥å‘é€åˆ°æœåŠ¡å™¨ï¼Œä½†é€šå¸¸ä¸éœ€è¦ï¼ˆTrickle ICEï¼‰
                }
            };

            publishPc.onconnectionstatechange = () => {
                const state = publishPc.connectionState;
                if (state === 'connected') {
                    statusEl.textContent = 'æ¨æµæˆåŠŸï¼è¿æ¥å·²å»ºç«‹';
                    statusEl.className = 'status success';
                    document.getElementById('startPublish').disabled = true;
                    document.getElementById('stopPublish').disabled = false;
                } else if (state === 'failed' || state === 'disconnected') {
                    statusEl.textContent = `è¿æ¥çŠ¶æ€: ${state}`;
                    statusEl.className = 'status error';
                }
            };

        } catch (error) {
            statusEl.textContent = `é”™è¯¯: ${error.message}`;
            statusEl.className = 'status error';
            console.error('æ¨æµé”™è¯¯:', error);
        }
    });

    document.getElementById('stopPublish').addEventListener('click', () => {
        if (publishPc) {
            publishPc.close();
            publishPc = null;
        }
        if (localStream) {
            localStream.getTracks().forEach(track => track.stop());
            localStream = null;
        }
        document.getElementById('localVideo').srcObject = null;
        document.getElementById('publishStatus').textContent = 'æ¨æµå·²åœæ­¢';
        document.getElementById('publishStatus').className = 'status';
        document.getElementById('startPublish').disabled = false;
        document.getElementById('stopPublish').disabled = true;
    });

    // ==================== æ‹‰æµåŠŸèƒ½ ====================

    document.getElementById('startPlay').addEventListener('click', async () => {
        const apiUrl = document.getElementById('playApiUrl').value.trim();
        const streamUrl = document.getElementById('playUrl').value.trim();
        const statusEl = document.getElementById('playStatus');

        if (!apiUrl || !streamUrl) {
            statusEl.textContent = 'é”™è¯¯: è¯·å¡«å†™ API åœ°å€å’Œæµ URL';
            statusEl.className = 'status error';
            return;
        }

        try {
            statusEl.textContent = 'æ­£åœ¨åˆ›å»ºè¿æ¥...';
            statusEl.className = 'status';

            // åˆ›å»º PeerConnection
            playPc = new RTCPeerConnection(config);

            // å¤„ç†è¿œç¨‹æµ
            playPc.ontrack = (event) => {
                document.getElementById('remoteVideo').srcObject = event.streams[0];
                statusEl.textContent = 'æ‹‰æµæˆåŠŸï¼æ­£åœ¨æ¥æ”¶è§†é¢‘...';
                statusEl.className = 'status success';
            };

            // åˆ›å»º Offer
            statusEl.textContent = 'æ­£åœ¨åˆ›å»º SDP Offer...';
            const offer = await playPc.createOffer();
            await playPc.setLocalDescription(offer);

            // å‘é€åˆ°æœåŠ¡å™¨
            statusEl.textContent = 'æ­£åœ¨è¿æ¥æœåŠ¡å™¨...';
            const response = await fetch(`${apiUrl}/rtc/v1/play/`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    api: streamUrl,
                    sdp: offer.sdp
                })
            });

            const data = await response.json();

            if (data.code !== 0) {
                throw new Error(data.data?.error || 'æœåŠ¡å™¨è¿”å›é”™è¯¯');
            }

            // è®¾ç½® Answer
            await playPc.setRemoteDescription({
                type: 'answer',
                sdp: data.sdp
            });

            // å¤„ç† ICE å€™é€‰
            playPc.onicecandidate = (event) => {
                if (event.candidate) {
                    // å¯ä»¥å‘é€åˆ°æœåŠ¡å™¨ï¼Œä½†é€šå¸¸ä¸éœ€è¦ï¼ˆTrickle ICEï¼‰
                }
            };

            playPc.onconnectionstatechange = () => {
                const state = playPc.connectionState;
                if (state === 'connected') {
                    statusEl.textContent = 'æ‹‰æµæˆåŠŸï¼è¿æ¥å·²å»ºç«‹';
                    statusEl.className = 'status success';
                    document.getElementById('startPlay').disabled = true;
                    document.getElementById('stopPlay').disabled = false;
                } else if (state === 'failed' || state === 'disconnected') {
                    statusEl.textContent = `è¿æ¥çŠ¶æ€: ${state}`;
                    statusEl.className = 'status error';
                }
            };

        } catch (error) {
            statusEl.textContent = `é”™è¯¯: ${error.message}`;
            statusEl.className = 'status error';
            console.error('æ‹‰æµé”™è¯¯:', error);
        }
    });

    document.getElementById('stopPlay').addEventListener('click', () => {
        if (playPc) {
            playPc.close();
            playPc = null;
        }
        document.getElementById('remoteVideo').srcObject = null;
        document.getElementById('playStatus').textContent = 'æ‹‰æµå·²åœæ­¢';
        document.getElementById('playStatus').className = 'status';
        document.getElementById('startPlay').disabled = false;
        document.getElementById('stopPlay').disabled = true;
    });
</script>
</body>
</html>


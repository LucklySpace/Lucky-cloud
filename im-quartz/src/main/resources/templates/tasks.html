<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>任务列表 - 任务调度中心</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <meta content="width=device-width, initial-scale=1.0" name="viewport">
</head>
<body class="bg-slate-50 text-slate-800 font-sans">

<div th:replace="~{fragments/nav :: nav}"></div>

<div class="container mx-auto px-6 py-8">
    <div class="flex justify-between items-center mb-8">
        <div>
            <h1 class="text-3xl font-bold text-slate-800">任务管理</h1>
            <p class="text-slate-500 mt-1">管理和配置您的定时任务。</p>
        </div>
        <div class="space-x-2">
            <button class="bg-indigo-600 text-white px-5 py-2.5 rounded-lg hover:bg-indigo-700 transition-all shadow-md hover:shadow-lg flex items-center transform hover:-translate-y-0.5"
                    onclick="openModal('new')">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path d="M12 6v6m0 0v6m0-6h6m-6 0H6" stroke-linecap="round" stroke-linejoin="round"
                          stroke-width="2"></path>
                </svg>
                新建任务
            </button>
        </div>
    </div>

    <div class="bg-white shadow-sm rounded-xl border border-slate-200 overflow-hidden">
        <div class="overflow-x-auto">
            <table class="min-w-full leading-normal">
                <thead>
                <tr class="bg-slate-50 border-b border-slate-200">
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                        任务名称
                    </th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                        分组
                    </th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                        调度规则
                    </th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                        状态
                    </th>
                    <th class="px-6 py-4 text-left text-xs font-semibold text-slate-500 uppercase tracking-wider">
                        操作
                    </th>
                </tr>
                </thead>
                <tbody class="divide-y divide-slate-100">
                <tr class="hover:bg-slate-50 transition-colors" th:each="task : ${tasks}">
                    <td class="px-6 py-4 whitespace-nowrap">
                        <div class="flex items-center">
                            <div class="flex-shrink-0 h-10 w-10 rounded-full bg-indigo-100 flex items-center justify-center text-indigo-500 font-bold">
                                <span th:text="${#strings.substring(task.jobName, 0, 1)}">T</span>
                            </div>
                            <div class="ml-4">
                                <a class="text-sm font-medium text-indigo-600 hover:text-indigo-900"
                                   th:href="@{/tasks/{id}(id=${task.id})}"
                                   th:text="${task.jobName}">Name</a>
                                <p class="text-xs text-slate-500 truncate max-w-xs" th:text="${task.description}">
                                    Desc</p>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">
                        <span class="px-2 py-1 bg-slate-100 rounded text-xs" th:text="${task.jobGroup}">Group</span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-slate-600">
                        <div class="flex flex-col">
                            <span class="font-mono" th:if="${task.scheduleType.name() == 'CRON'}"
                                  th:text="${task.cronExpression}"></span>
                            <span class="font-mono" th:if="${task.scheduleType.name() != 'CRON'}"
                                  th:text="${task.repeatInterval} + ' ms'"></span>
                            <span class="text-xs text-slate-400 mt-0.5" th:text="${task.scheduleType}"></span>
                        </div>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span th:class="${'px-3 py-1 inline-flex text-xs leading-5 font-semibold rounded-full ' + 
                            (task.status.name() == 'RUNNING' ? 'bg-emerald-100 text-emerald-800' : 
                            (task.status.name() == 'STOPPED' ? 'bg-rose-100 text-rose-800' : 'bg-amber-100 text-amber-800'))}"
                              th:text="${task.status}">
                            Status
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <div class="flex items-center space-x-3">
                            <form class="inline"
                                  method="post" th:action="@{/tasks/{id}/start(id=${task.id})}" th:if="${task.status.name() != 'RUNNING'}">
                                <button class="text-emerald-600 hover:text-emerald-900 flex items-center" title="启动"
                                        type="submit">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path d="M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z" stroke-linecap="round" stroke-linejoin="round"
                                              stroke-width="2"></path>
                                        <path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round"
                                              stroke-width="2"></path>
                                    </svg>
                                </button>
                            </form>
                            <form class="inline"
                                  method="post" th:action="@{/tasks/{id}/stop(id=${task.id})}" th:if="${task.status.name() == 'RUNNING'}">
                                <button class="text-amber-600 hover:text-amber-900 flex items-center" title="停止"
                                        type="submit">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path d="M10 9v6m4-6v6m7-3a9 9 0 11-18 0 9 9 0 0118 0z" stroke-linecap="round" stroke-linejoin="round"
                                              stroke-width="2"></path>
                                    </svg>
                                </button>
                            </form>
                            <form class="inline" method="post" th:action="@{/tasks/{id}/trigger(id=${task.id})}">
                                <button class="text-indigo-600 hover:text-indigo-900 flex items-center" title="执行一次"
                                        type="submit">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path d="M13 10V3L4 14h7v7l9-11h-7z" stroke-linecap="round" stroke-linejoin="round"
                                              stroke-width="2"></path>
                                    </svg>
                                </button>
                            </form>
                            <button class="text-slate-600 hover:text-slate-900 flex items-center"
                                    th:onclick="'openModal(\'edit\', ' + ${task.id} + ')'" title="编辑">
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" stroke-linecap="round" stroke-linejoin="round"
                                          stroke-width="2"></path>
                                </svg>
                            </button>
                            <form class="inline" method="post" onsubmit="return confirm('确定要删除吗?');"
                                  th:action="@{/tasks/{id}/delete(id=${task.id})}">
                                <button class="text-rose-600 hover:text-rose-900 flex items-center" title="删除"
                                        type="submit">
                                    <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" stroke-linecap="round" stroke-linejoin="round"
                                              stroke-width="2"></path>
                                    </svg>
                                </button>
                            </form>
                        </div>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="fixed inset-0 bg-slate-900 bg-opacity-75 overflow-y-auto h-full w-full hidden backdrop-blur-sm transition-opacity z-50"
     id="taskModal">
    <div class="relative top-10 mx-auto p-0 border-0 w-full max-w-2xl shadow-2xl rounded-xl bg-white transform transition-all mb-10">
        <div class="flex justify-between items-center px-6 py-4 border-b border-slate-100 bg-slate-50 rounded-t-xl">
            <h3 class="text-lg font-bold text-slate-800" id="modalTitle">新建任务</h3>
            <button class="text-slate-400 hover:text-slate-600 transition-colors rounded-full p-1 hover:bg-slate-200"
                    onclick="closeModal()">
                <svg class="h-6 w-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path d="M6 18L18 6M6 6l12 12" stroke-linecap="round" stroke-linejoin="round"
                          stroke-width="2"></path>
                </svg>
            </button>
        </div>

        <form class="p-6 space-y-6" id="taskForm" onsubmit="return false;">
            <input id="taskId" name="id" type="hidden">
            <input id="taskStatus" name="status" type="hidden">

            <!-- Basic Info -->
            <div class="space-y-4">
                <h4 class="text-sm font-semibold text-slate-500 uppercase tracking-wider border-b pb-1">基本信息</h4>
                <div class="grid grid-cols-2 gap-6">
                    <div>
                        <label class="block text-slate-700 text-sm font-medium mb-1">任务名称 <span
                                class="text-red-500">*</span></label>
                        <input class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-shadow"
                               id="jobName" name="jobName" placeholder="例如: OrderCancelJob" required type="text">
                    </div>
                    <div>
                        <label class="block text-slate-700 text-sm font-medium mb-1">任务分组 <span
                                class="text-red-500">*</span></label>
                        <input class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-shadow"
                               id="jobGroup" name="jobGroup" required type="text" value="DEFAULT">
                    </div>
                </div>
                <div>
                    <label class="block text-slate-700 text-sm font-medium mb-1">任务描述</label>
                    <textarea
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-shadow"
                            id="description" name="description" placeholder="简要描述任务的功能" rows="2"></textarea>
                </div>
            </div>

            <!-- Execution Config -->
            <div class="space-y-4">
                <h4 class="text-sm font-semibold text-slate-500 uppercase tracking-wider border-b pb-1">执行配置</h4>

                <div>
                    <label class="block text-slate-700 text-sm font-medium mb-1">触发类型 <span
                            class="text-red-500">*</span></label>
                    <select class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-shadow bg-white"
                            id="triggerType" name="triggerType" onchange="toggleTriggerFields()">
                        <option value="LOCAL">本地任务 (Local)</option>
                        <option value="REMOTE">远程任务 (Remote)</option>
                    </select>
                </div>

                <div id="localFields">
                    <label class="block text-slate-700 text-sm font-medium mb-1">执行类 (全类名/Bean名) <span
                            class="text-red-500">*</span></label>
                    <div class="relative">
                        <input class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-shadow font-mono text-sm"
                               id="jobClass" name="jobClass" placeholder="com.example.job.MyJob">
                        <div class="absolute inset-y-0 right-0 pr-3 flex items-center pointer-events-none text-slate-400 text-xs">
                            Local
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-6" id="remoteFields" style="display:none;">
                    <div>
                        <label class="block text-slate-700 text-sm font-medium mb-1">目标应用 (AppName) <span
                                class="text-red-500">*</span></label>
                        <input class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-shadow"
                               id="appName" list="appNameList" name="appName" placeholder="选择或输入应用名称">
                        <datalist id="appNameList">
                            <!-- Populated by JS -->
                        </datalist>
                    </div>
                    <div>
                        <label class="block text-slate-700 text-sm font-medium mb-1">任务处理器 (@LuckyJob) <span
                                class="text-red-500">*</span></label>
                        <input class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-shadow"
                               id="jobHandler" name="jobHandler" placeholder="e.g. orderTimeoutJob">
                    </div>
                </div>

                <div>
                    <label class="block text-slate-700 text-sm font-medium mb-1">任务参数 (JSON)</label>
                    <textarea
                            class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-shadow font-mono text-sm bg-slate-50"
                            id="jobData" name="jobData" placeholder='{"key": "value"}' rows="2"></textarea>
                </div>
            </div>

            <!-- Schedule Config -->
            <div class="space-y-4">
                <h4 class="text-sm font-semibold text-slate-500 uppercase tracking-wider border-b pb-1">调度策略</h4>

                <div>
                    <label class="block text-slate-700 text-sm font-medium mb-1">调度类型 <span
                            class="text-red-500">*</span></label>
                    <select class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-shadow bg-white"
                            id="scheduleType" name="scheduleType" onchange="toggleScheduleFields()">
                        <option value="CRON">Cron 表达式</option>
                        <option value="FIXED_RATE">固定频率 (Fixed Rate)</option>
                        <option value="FIXED_DELAY">固定延迟 (Fixed Delay)</option>
                    </select>
                </div>

                <div class="bg-slate-50 p-4 rounded-lg border border-slate-200">
                    <div id="cronField">
                        <label class="block text-slate-700 text-sm font-medium mb-1">Cron 表达式 <span
                                class="text-red-500">*</span></label>
                        <div class="flex space-x-2">
                            <input class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-shadow font-mono text-sm"
                                   id="cronExpression" name="cronExpression" placeholder="0/5 * * * * ?">
                            <a class="inline-flex items-center px-3 py-2 border border-slate-300 shadow-sm text-sm font-medium rounded-md text-slate-700 bg-white hover:bg-slate-50"
                               href="https://cron.qqe2.com/" target="_blank">生成</a>
                        </div>
                    </div>
                    <div id="intervalField" style="display:none;">
                        <label class="block text-slate-700 text-sm font-medium mb-1">时间间隔 (ms) <span
                                class="text-red-500">*</span></label>
                        <input class="w-full px-4 py-2 border border-slate-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 outline-none transition-shadow"
                               id="repeatInterval" name="repeatInterval" placeholder="5000" type="number">
                    </div>
                </div>
            </div>

            <!-- Advanced Config -->
            <div class="space-y-4">
                <h4 class="text-sm font-semibold text-slate-500 uppercase tracking-wider border-b pb-1">高级配置</h4>

                <div>
                    <label class="block text-slate-700 text-sm font-medium mb-2">并发策略</label>
                    <div class="flex space-x-6">
                        <label class="inline-flex items-center cursor-pointer">
                            <input checked class="form-radio text-indigo-600 focus:ring-indigo-500 h-4 w-4"
                                   name="concurrencyStrategy" type="radio" value="SERIAL">
                            <span class="ml-2 text-slate-700">串行 (等待上一次完成)</span>
                        </label>
                        <label class="inline-flex items-center cursor-pointer">
                            <input class="form-radio text-indigo-600 focus:ring-indigo-500 h-4 w-4"
                                   name="concurrencyStrategy" type="radio" value="PARALLEL">
                            <span class="ml-2 text-slate-700">并行 (忽略上一次状态)</span>
                        </label>
                    </div>
                </div>

                <div class="grid grid-cols-3 gap-4">
                    <div>
                        <label class="block text-slate-600 text-xs font-semibold mb-1">重试次数</label>
                        <input class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-1 focus:ring-indigo-500 outline-none text-sm"
                               id="retryCount" name="retryCount" type="number" value="0">
                    </div>
                    <div>
                        <label class="block text-slate-600 text-xs font-semibold mb-1">重试间隔(s)</label>
                        <input class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-1 focus:ring-indigo-500 outline-none text-sm"
                               id="retryInterval" name="retryInterval" type="number" value="10">
                    </div>
                    <div>
                        <label class="block text-slate-600 text-xs font-semibold mb-1">超时时间(s)</label>
                        <input class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-1 focus:ring-indigo-500 outline-none text-sm"
                               id="timeout" name="timeout" type="number" value="0">
                    </div>
                </div>
                <div>
                    <label class="block text-slate-600 text-xs font-semibold mb-1">报警邮件</label>
                    <input class="w-full px-3 py-2 border border-slate-300 rounded-md focus:ring-1 focus:ring-indigo-500 outline-none text-sm"
                           id="alarmEmail" name="alarmEmail" placeholder="接收告警通知的邮箱地址" type="email">
                </div>
            </div>

            <div class="flex justify-end pt-4 border-t border-slate-100 bg-slate-50 -mx-6 -mb-6 px-6 py-4 rounded-b-xl">
                <button class="mr-3 px-5 py-2.5 bg-white border border-slate-300 text-slate-700 rounded-lg hover:bg-slate-50 transition-colors font-medium shadow-sm"
                        onclick="closeModal()" type="button">取消
                </button>
                <button class="px-5 py-2.5 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition-colors font-medium shadow-md"
                        onclick="submitTask()" type="button">保存配置
                </button>
            </div>
        </form>
    </div>
</div>

<script>
    // Load app names on page load
    document.addEventListener('DOMContentLoaded', function () {
        fetch('/api/tasks/apps')
            .then(response => response.json())
            .then(apps => {
                const datalist = document.getElementById('appNameList');
                datalist.innerHTML = '';
                apps.forEach(app => {
                    const option = document.createElement('option');
                    option.value = app;
                    datalist.appendChild(option);
                });
            })
            .catch(err => console.error('Failed to load app names:', err));
    });

    function toggleScheduleFields() {
        const type = document.getElementById('scheduleType').value;
        const cronField = document.getElementById('cronField');
        const intervalField = document.getElementById('intervalField');

        if (type === 'CRON') {
            cronField.style.display = 'block';
            intervalField.style.display = 'none';
        } else {
            cronField.style.display = 'none';
            intervalField.style.display = 'block';
        }
    }

    function toggleTriggerFields() {
        const type = document.getElementById('triggerType').value;
        const localFields = document.getElementById('localFields');
        const remoteFields = document.getElementById('remoteFields');

        const jobClass = document.getElementById('jobClass');
        const appName = document.getElementById('appName');
        const jobHandler = document.getElementById('jobHandler');

        if (type === 'LOCAL') {
            localFields.style.display = 'block';
            remoteFields.style.display = 'none';
            jobClass.setAttribute('required', '');
            appName.removeAttribute('required');
            jobHandler.removeAttribute('required');
        } else {
            localFields.style.display = 'none';
            remoteFields.style.display = 'grid';
            jobClass.removeAttribute('required');
            appName.setAttribute('required', '');
            jobHandler.setAttribute('required', '');
        }
    }

    function openModal(mode, id) {
        const modal = document.getElementById('taskModal');
        const form = document.getElementById('taskForm');

        modal.classList.remove('hidden');
        
        if (mode === 'new') {
            document.getElementById('modalTitle').innerText = '新建任务';
            form.reset();
            document.getElementById('taskId').value = '';
            document.getElementById('taskStatus').value = 'STOPPED';
            // Set defaults
            document.getElementById('scheduleType').value = 'CRON';
            document.getElementById('triggerType').value = 'LOCAL';
            document.getElementById('concurrencyStrategy').value = 'SERIAL'; // This might need radio logic fix
            document.querySelector('input[name="concurrencyStrategy"][value="SERIAL"]').checked = true;
            
            toggleScheduleFields();
            toggleTriggerFields();
        } else {
            document.getElementById('modalTitle').innerText = '编辑任务';
            // Fetch task details
            fetch('/api/tasks/' + id)
                .then(response => response.json())
                .then(data => {
                    document.getElementById('taskId').value = data.id;
                    document.getElementById('taskStatus').value = data.status;
                    document.getElementById('jobName').value = data.jobName;
                    document.getElementById('jobGroup').value = data.jobGroup;
                    document.getElementById('description').value = data.description || '';
                    document.getElementById('jobClass').value = data.jobClass || '';
                    document.getElementById('jobData').value = data.jobData || '';
                    document.getElementById('scheduleType').value = data.scheduleType;
                    document.getElementById('cronExpression').value = data.cronExpression || '';
                    document.getElementById('repeatInterval').value = data.repeatInterval || '';
                    document.getElementById('triggerType').value = data.triggerType || 'LOCAL';
                    document.getElementById('appName').value = data.appName || '';
                    document.getElementById('jobHandler').value = data.jobHandler || '';
                    document.getElementById('retryCount').value = data.retryCount || 0;
                    document.getElementById('retryInterval').value = data.retryInterval || 10;
                    document.getElementById('timeout').value = data.timeout || 0;
                    document.getElementById('alarmEmail').value = data.alarmEmail || '';

                    // Radio button for concurrencyStrategy
                    const cs = data.concurrencyStrategy || 'SERIAL';
                    document.querySelector(`input[name="concurrencyStrategy"][value="${cs}"]`).checked = true;

                    toggleScheduleFields();
                    toggleTriggerFields();
                })
                .catch(err => {
                    console.error(err);
                    alert('加载任务详情失败');
                    closeModal();
                });
        }
    }

    function closeModal() {
        document.getElementById('taskModal').classList.add('hidden');
    }

    function submitTask() {
        const form = document.getElementById('taskForm');
        if (!form.checkValidity()) {
            form.reportValidity();
            return;
        }

        const formData = new FormData(form);
        const data = Object.fromEntries(formData.entries());
        const id = data.id;
        const method = id ? 'PUT' : 'POST';
        const url = id ? '/api/tasks/' + id : '/api/tasks';

        // Validate
        if (data.scheduleType === 'CRON' && !data.cronExpression) {
            alert('请输入 Cron 表达式');
            return;
        }
        if (data.scheduleType !== 'CRON' && (!data.repeatInterval || data.repeatInterval <= 0)) {
            alert('请输入有效的时间间隔');
            return;
        }

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        })
            .then(response => {
                if (response.ok) {
                    window.location.reload();
                } else {
                    response.text().then(text => alert('保存失败: ' + text));
                }
            })
            .catch(err => {
                console.error(err);
                alert('保存失败: 网络错误');
            });
    }

    // Close modal when clicking outside
    window.onclick = function (event) {
        const modal = document.getElementById('taskModal');
        if (event.target == modal) {
            closeModal();
        }
    }
</script>

</body>
</html>
